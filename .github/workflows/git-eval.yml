name: Git-Eval S Rank

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read config
        id: config
        run: |
          if [ -f git-eval-config.json ]; then
            echo "build=$(jq -r '.build // empty' git-eval-config.json)" >> $GITHUB_OUTPUT
            echo "test=$(jq -r '.test // empty' git-eval-config.json)" >> $GITHUB_OUTPUT
            echo "lint=$(jq -r '.lint // empty' git-eval-config.json)" >> $GITHUB_OUTPUT
          fi

      - name: CI checks
        id: ci
        run: |
          CI_SCORE=0
          CI_FEEDBACK=""

          TEST_CMD="${{ steps.config.outputs.test }}"
          LINT_CMD="${{ steps.config.outputs.lint }}"

          if [ -n "$TEST_CMD" ] && timeout 120 bash -c "$TEST_CMD" > /dev/null 2>&1; then
            CI_SCORE=$((CI_SCORE + 5))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ „ÉÜ„Çπ„ÉàÈÄöÈÅé\n"
          elif [ -n "$TEST_CMD" ]; then
            CI_FEEDBACK="${CI_FEEDBACK}‚ùå „ÉÜ„Çπ„ÉàÂ§±Êïó\n"
          fi

          if [ -n "$LINT_CMD" ] && timeout 120 bash -c "$LINT_CMD" > /dev/null 2>&1; then
            CI_SCORE=$((CI_SCORE + 5))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ „É™„É≥„Çø„ÉºÈÄöÈÅé\n"
          elif [ -n "$LINT_CMD" ]; then
            CI_FEEDBACK="${CI_FEEDBACK}‚ùå „É™„É≥„Çø„Éº„Ç®„É©„Éº\n"
          fi

          echo "ci_score=$CI_SCORE" >> $GITHUB_OUTPUT
          {
            echo "ci_feedback<<CI_EOF"
            echo -e "$CI_FEEDBACK"
            echo "CI_EOF"
          } >> $GITHUB_OUTPUT

      - name: Collect source code
        id: source
        run: |
          {
            echo "code<<CODE_EOF"
            find . -path './.git' -prune -o -path './node_modules' -prune -o \
              \( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.go' -o -name '*.rs' -o -name '*.java' -o -name '*.rb' \) \
              -print | head -40 | while read f; do
              echo "=== $f ==="
              head -300 "$f"
            done
            if [ -f DECISION.md ]; then
              echo "=== DECISION.md ==="
              cat DECISION.md
            fi
            echo "CODE_EOF"
          } >> $GITHUB_OUTPUT

      - name: LLM evaluation
        id: llm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "llm_score=0" >> $GITHUB_OUTPUT
            echo "llm_feedback=‚è≠Ô∏è ANTHROPIC_API_KEY Êú™Ë®≠ÂÆö" >> $GITHUB_OUTPUT
            exit 0
          fi

          SOURCE_CODE="${{ steps.source.outputs.code }}"

          PROMPT="„ÅÇ„Å™„Åü„ÅØÊäÄË°ìÈÅ∏ÂÆö„Å´Âé≥„Åó„ÅÑ„Ç∑„Éã„Ç¢„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Çí S „É©„É≥„ÇØÔºàSpecialistÔºâ„ÅÆÂü∫Ê∫ñ„ÅßÂé≥Ê†º„Å´Ë©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          S „É©„É≥„ÇØ„ÅØÊúÄÈ´ò„É©„É≥„ÇØ„Åß„Åô„ÄÇ„ÄåÁõÆÁöÑ„Å´ÂØæ„Åó„Å¶ÊúÄÈÅ©„Å™ÊâãÊÆµ„ÇíÈÅ∏„Çì„Åß„ÅÑ„Çã„Åã„Äç„ÅåÊúÄÈáçË¶Å„Åß„Åô„ÄÇ
          ÁõÆÁöÑ„Å®ÊâãÊÆµ„ÅÆÈÄÜËª¢ÔºàÊäÄË°ì„Çí‰Ωø„ÅÑ„Åü„ÅÑ„Å†„Åë„ÄÅ„Ç™„Éº„Éê„Éº„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞Ôºâ„Å´„ÅØÂé≥„Åó„ÅèÊ∏õÁÇπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          Ë©ï‰æ°Âü∫Ê∫ñÔºàÂêÑÈ†ÖÁõÆ 0„ÄúÊåáÂÆöÁÇπ„ÅßÊé°ÁÇπÔºâ:
          1. ÊäÄË°ìÈÅ∏ÂÆö„ÅÆÈÅ©Âàá„Åï: 0„Äú30 ÁÇπ
             - ÁõÆÁöÑ„Å´ÂØæ„Åó„Å¶ÊúÄÈÅ©„Å™ÊäÄË°ì„ÇíÈÅ∏„Çì„Åß„ÅÑ„Çã„Åã
             - ‰ª£ÊõøÊ°à„Å®ÊØîËºÉ„Åó„Åü‰∏ä„ÅßÈÅ∏ÂÆö„Åó„Å¶„ÅÑ„Çã„Åã
          2. ÁõÆÁöÑ„Å®ÊâãÊÆµ„ÅÆ‰∏ÄËá¥: 0„Äú25 ÁÇπ
             - „Ç™„Éº„Éê„Éº„Çπ„Éö„ÉÉ„ÇØ„Åß„ÅØ„Å™„ÅÑ„Åã
             - ‰∏çË∂≥„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã
             - YAGNI / KISS „ÅåÂÆà„Çâ„Çå„Å¶„ÅÑ„Çã„Åã
          3. ÂâµÊÑèÂ∑•Â§´„ÉªÊúÄÈÅ©Âåñ: 0„Äú20 ÁÇπ
             - Áã¨Ëá™„ÅÆ„Ç¢„Éó„É≠„Éº„ÉÅ„Åå„ÅÇ„Çã„Åã
             - „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Å∏„ÅÆÈÖçÊÖÆ
          4. Á∑èÂêàÂäõ: 0„Äú15 ÁÇπ
             - „Ç≥„Éº„ÉâÂìÅË≥™„ÄÅË®≠Ë®à„ÄÅ„ÉÜ„Çπ„Éà„ÄÅ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆÁ∑èÂêàË©ï‰æ°

          DECISION.md „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Ç≥„Éº„Éâ„Å®Á™Å„ÅçÂêà„Çè„Åõ„Å¶„ÄåÂà§Êñ≠„ÅÆÂ¶•ÂΩìÊÄß„Äç„ÇíË©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ÂøÖ„Åö‰ª•‰∏ã„ÅÆ JSON ÂΩ¢Âºè„ÅßÂõûÁ≠î:
          {\"tech_selection\": ÁÇπÊï∞, \"purpose_means\": ÁÇπÊï∞, \"innovation\": ÁÇπÊï∞, \"overall\": ÁÇπÊï∞, \"feedback\": \"Êó•Êú¨Ë™û„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ\"}

          „Ç≥„Éº„Éâ:
          ${SOURCE_CODE}"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{model: "claude-sonnet-4-20250514", max_tokens: 1500, messages: [{role: "user", content: $prompt}]}')")

          LLM_TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -n "$LLM_TEXT" ]; then
            LLM_JSON=$(echo "$LLM_TEXT" | python3 -c "
import sys, json
text = sys.stdin.read()
start = text.find('{')
if start >= 0:
    depth = 0
    for i in range(start, len(text)):
        if text[i] == '{': depth += 1
        elif text[i] == '}': depth -= 1
        if depth == 0:
            try:
                json.loads(text[start:i+1])
                print(text[start:i+1])
            except: pass
            break
")
            if [ -n "$LLM_JSON" ]; then
              TS=$(echo "$LLM_JSON" | jq -r '.tech_selection // 0')
              PM=$(echo "$LLM_JSON" | jq -r '.purpose_means // 0')
              IN=$(echo "$LLM_JSON" | jq -r '.innovation // 0')
              OV=$(echo "$LLM_JSON" | jq -r '.overall // 0')
              LLM_FB=$(echo "$LLM_JSON" | jq -r '.feedback // "Ë©ï‰æ°ÂÆå‰∫Ü"')
              LLM_SCORE=$((TS + PM + IN + OV))
              echo "llm_score=$LLM_SCORE" >> $GITHUB_OUTPUT
              {
                echo "llm_feedback<<LLM_EOF"
                echo "üìù ÊäÄË°ìÈÅ∏ÂÆö ${TS}/30 | ÁõÆÁöÑÊâãÊÆµ ${PM}/25 | ÂâµÊÑèÂ∑•Â§´ ${IN}/20 | Á∑èÂêà ${OV}/15"
                echo "$LLM_FB"
                echo "LLM_EOF"
              } >> $GITHUB_OUTPUT
            else
              echo "llm_score=0" >> $GITHUB_OUTPUT
              echo "llm_feedback=‚ö†Ô∏è LLM ÂøúÁ≠î„ÅÆËß£Êûê„Å´Â§±Êïó" >> $GITHUB_OUTPUT
            fi
          else
            echo "llm_score=0" >> $GITHUB_OUTPUT
            echo "llm_feedback=‚ö†Ô∏è LLM API „Ç®„É©„Éº" >> $GITHUB_OUTPUT
          fi

      - name: Send results to Git-Eval
        if: always()
        env:
          WEBHOOK_SECRET: ${{ secrets.GIT_EVAL_SECRET }}
          WEBHOOK_URL: ${{ secrets.GIT_EVAL_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ] || [ -z "$WEBHOOK_SECRET" ]; then
            echo "Webhook not configured, skipping"
            exit 0
          fi

          CI_SCORE=${{ steps.ci.outputs.ci_score }}
          LLM_SCORE=${{ steps.llm.outputs.llm_score }}
          TOTAL=$((CI_SCORE + LLM_SCORE))

          FEEDBACK="„ÄêCI/CD„Äë\n${{ steps.ci.outputs.ci_feedback }}\n„ÄêLLM Ë©ï‰æ°„Äë\n${{ steps.llm.outputs.llm_feedback }}\n\nÂêàË®à: ${TOTAL}/100"

          BODY=$(jq -n \
            --arg user "${{ github.actor }}" \
            --argjson score "$TOTAL" \
            --arg feedback "$FEEDBACK" \
            --arg rank "S" \
            '{github_username: $user, score: $score, feedback: $feedback, rank: $rank}')

          SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          curl -sf -X POST "${WEBHOOK_URL}/webhook/eval" \
            -H "Content-Type: application/json" \
            -H "X-Signature-256: sha256=${SIG}" \
            -d "$BODY"
